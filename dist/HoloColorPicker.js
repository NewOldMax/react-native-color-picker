"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.HoloColorPicker = void 0;
const react_1 = __importDefault(require("react"));
const react_native_1 = require("react-native");
const tinycolor2_1 = __importDefault(require("tinycolor2"));
const slider_1 = __importDefault(require("@react-native-community/slider"));
const utils_1 = require("./utils");
class HoloColorPicker extends react_1.default.PureComponent {
    _layout;
    _pageX;
    _pageY;
    _isRTL;
    _pickerResponder;
    pickerContainer;
    constructor(props, ctx) {
        super(props, ctx);
        const state = {
            color: { h: 0, s: 1, v: 1 },
            pickerSize: 0,
        };
        if (props.oldColor) {
            state.color = (0, tinycolor2_1.default)(props.oldColor).toHsv();
        }
        if (props.defaultColor) {
            state.color = (0, tinycolor2_1.default)(props.defaultColor).toHsv();
        }
        this.state = state;
        this._layout = { width: 0, height: 0, x: 0, y: 0 };
        this._pageX = 0;
        this._pageY = 0;
        this._onLayout = this._onLayout.bind(this);
        this._onSValueChange = this._onSValueChange.bind(this);
        this._onVValueChange = this._onVValueChange.bind(this);
        this._onColorSelected = this._onColorSelected.bind(this);
        this._onOldColorSelected = this._onOldColorSelected.bind(this);
        this._isRTL = react_native_1.I18nManager.isRTL;
        this._pickerResponder = (0, utils_1.createPanResponder)({
            onStart: this._handleColorChange,
            onMove: this._handleColorChange,
        });
        this.pickerContainer = react_1.default.createRef();
    }
    _getColor() {
        const passedColor = typeof this.props.color === "string"
            ? (0, tinycolor2_1.default)(this.props.color).toHsv()
            : this.props.color;
        return passedColor || this.state.color;
    }
    _onColorSelected() {
        const { onColorSelected } = this.props;
        const color = (0, tinycolor2_1.default)(this._getColor()).toHexString();
        onColorSelected && onColorSelected(color);
    }
    _onOldColorSelected() {
        const { oldColor, onOldColorSelected } = this.props;
        const color = (0, tinycolor2_1.default)(oldColor);
        this.setState({ color: color.toHsv() });
        onOldColorSelected && onOldColorSelected(color.toHexString());
    }
    _onSValueChange(s) {
        const { h, v } = this._getColor();
        this._onColorChange({ h, s, v });
    }
    _onVValueChange(v) {
        const { h, s } = this._getColor();
        this._onColorChange({ h, s, v });
    }
    _onColorChange(color) {
        this.setState({ color });
        if (this.props.onColorChange) {
            this.props.onColorChange(color);
        }
    }
    _onLayout(l) {
        this._layout = l.nativeEvent.layout;
        const { width, height } = this._layout;
        const pickerSize = Math.min(width, height);
        if (this.state.pickerSize !== pickerSize) {
            this.setState({ pickerSize });
        }
        // layout.x, layout.y is always 0
        // we always measure because layout is the same even though picker is moved on the page
        react_native_1.InteractionManager.runAfterInteractions(() => {
            // measure only after (possible) animation ended
            this.pickerContainer.current &&
                this.pickerContainer.current.measure((x, y, width, height, pageX, pageY) => {
                    // picker position in the screen
                    this._pageX = pageX;
                    this._pageY = pageY;
                });
        });
    }
    _handleColorChange = ({ x, y }) => {
        const { s, v } = this._getColor();
        const marginLeft = (this._layout.width - this.state.pickerSize) / 2;
        const marginTop = (this._layout.height - this.state.pickerSize) / 2;
        const relativeX = x - this._pageX - marginLeft;
        const relativeY = y - this._pageY - marginTop;
        const h = this._computeHValue(relativeX, relativeY);
        this._onColorChange({ h, s, v });
        return true;
    };
    _computeHValue(x, y) {
        const mx = this.state.pickerSize / 2;
        const my = this.state.pickerSize / 2;
        const dx = x - mx;
        const dy = y - my;
        const rad = Math.atan2(dx, dy) + Math.PI + Math.PI / 2;
        return ((rad * 180) / Math.PI) % 360;
    }
    _hValueToRad(deg) {
        const rad = (deg * Math.PI) / 180;
        return rad - Math.PI - Math.PI / 2;
    }
    _getSlider() {
        if (this.props.hideSliders) {
            return undefined;
        }
        if (this.props.sliderComponent) {
            return this.props.sliderComponent;
        }
        if (!slider_1.default) {
            throw new Error("You need to install `@react-native-community/slider` and pass it (or any other Slider compatible component) as `sliderComponent` prop");
        }
        return slider_1.default;
    }
    getColor() {
        return (0, tinycolor2_1.default)(this._getColor()).toHexString();
    }
    render() {
        const { pickerSize } = this.state;
        const { oldColor, style } = this.props;
        const color = this._getColor();
        const { h, s, v } = color;
        const angle = this._hValueToRad(h);
        const selectedColor = (0, tinycolor2_1.default)(color).toHexString();
        const indicatorColor = (0, tinycolor2_1.default)({ h, s: 1, v: 1 }).toHexString();
        const computed = makeComputedStyles({
            pickerSize,
            selectedColor,
            indicatorColor,
            oldColor,
            angle,
            isRTL: this._isRTL,
        });
        const SliderComp = this._getSlider();
        return (<react_native_1.View style={style}>
        <react_native_1.View onLayout={this._onLayout} ref={this.pickerContainer} style={styles.pickerContainer}>
          {!pickerSize ? null : (<react_native_1.View>
              <react_native_1.View {...this._pickerResponder.panHandlers} style={[computed.picker]} collapsable={false}>
                <react_native_1.Image source={require("../resources/color-circle.png")} resizeMode="contain" style={[styles.pickerImage]}/>
                <react_native_1.View style={[styles.pickerIndicator, computed.pickerIndicator]}/>
              </react_native_1.View>
              {oldColor && (<react_native_1.TouchableOpacity style={[styles.selectedPreview, computed.selectedPreview]} onPress={this._onColorSelected} activeOpacity={0.7}/>)}
              {oldColor && (<react_native_1.TouchableOpacity style={[styles.originalPreview, computed.originalPreview]} onPress={this._onOldColorSelected} activeOpacity={0.7}/>)}
              {!oldColor && (<react_native_1.TouchableOpacity style={[
                        styles.selectedFullPreview,
                        computed.selectedFullPreview,
                    ]} onPress={this._onColorSelected} activeOpacity={0.7}/>)}
            </react_native_1.View>)}
        </react_native_1.View>
        {this.props.hideSliders ? null : (<react_native_1.View>
            <SliderComp value={s} onValueChange={this._onSValueChange}/>
            <SliderComp value={v} onValueChange={this._onVValueChange}/>
          </react_native_1.View>)}
      </react_native_1.View>);
    }
}
exports.HoloColorPicker = HoloColorPicker;
const makeComputedStyles = ({ indicatorColor, selectedColor, oldColor, angle, pickerSize, isRTL, }) => {
    const summarySize = 0.5 * pickerSize;
    const indicatorPickerRatio = 42 / 510; // computed from picker image
    const indicatorSize = indicatorPickerRatio * pickerSize;
    const pickerPadding = indicatorSize / 3;
    const indicatorRadius = pickerSize / 2 - indicatorSize / 2 - pickerPadding;
    const mx = pickerSize / 2;
    const my = pickerSize / 2;
    const dx = Math.cos(angle) * indicatorRadius;
    const dy = Math.sin(angle) * indicatorRadius;
    return {
        picker: {
            padding: pickerPadding,
            width: pickerSize,
            height: pickerSize,
        },
        pickerIndicator: {
            top: mx + dx - indicatorSize / 2,
            [isRTL ? "right" : "left"]: my + dy - indicatorSize / 2,
            width: indicatorSize,
            height: indicatorSize,
            borderRadius: indicatorSize / 2,
            backgroundColor: indicatorColor,
        },
        selectedPreview: {
            width: summarySize / 2,
            height: summarySize,
            top: pickerSize / 2 - summarySize / 2,
            left: Math.floor(pickerSize / 2),
            borderTopRightRadius: summarySize / 2,
            borderBottomRightRadius: summarySize / 2,
            backgroundColor: selectedColor,
        },
        originalPreview: {
            width: Math.ceil(summarySize / 2),
            height: summarySize,
            top: pickerSize / 2 - summarySize / 2,
            left: pickerSize / 2 - summarySize / 2,
            borderTopLeftRadius: summarySize / 2,
            borderBottomLeftRadius: summarySize / 2,
            backgroundColor: oldColor,
        },
        selectedFullPreview: {
            width: summarySize,
            height: summarySize,
            top: pickerSize / 2 - summarySize / 2,
            left: pickerSize / 2 - summarySize / 2,
            borderRadius: summarySize / 2,
            backgroundColor: selectedColor,
        },
    };
};
const styles = react_native_1.StyleSheet.create({
    pickerContainer: {
        flex: 1,
        alignItems: "center",
        justifyContent: "center",
    },
    pickerImage: {
        flex: 1,
        width: null,
        height: null,
    },
    pickerIndicator: {
        position: "absolute",
        // Shadow only works on iOS.
        shadowColor: "black",
        shadowOpacity: 0.3,
        shadowOffset: { width: 3, height: 3 },
        shadowRadius: 4,
        // This will elevate the view on Android, causing shadow to be drawn.
        elevation: 5,
    },
    selectedPreview: {
        position: "absolute",
        borderLeftWidth: 0,
    },
    originalPreview: {
        position: "absolute",
        borderRightWidth: 0,
    },
    selectedFullPreview: {
        position: "absolute",
    },
    pickerAlignment: {
        alignItems: "center",
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSG9sb0NvbG9yUGlja2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL0hvbG9Db2xvclBpY2tlci50c3giXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsa0RBQTBCO0FBQzFCLCtDQVFzQjtBQUN0Qiw0REFBbUM7QUFDbkMsNEVBQW9EO0FBR3BELG1DQUE2QztBQWdCN0MsTUFBYSxlQUFnQixTQUFRLGVBQUssQ0FBQyxhQUcxQztJQUNTLE9BQU8sQ0FBMEQ7SUFDakUsTUFBTSxDQUFTO0lBQ2YsTUFBTSxDQUFTO0lBQ2YsTUFBTSxDQUFVO0lBQ2hCLGdCQUFnQixDQUF1QjtJQUN2QyxlQUFlLENBQXdCO0lBRS9DLFlBQVksS0FBdUIsRUFBRSxHQUFRO1FBQzNDLEtBQUssQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDbEIsTUFBTSxLQUFLLEdBQUc7WUFDWixLQUFLLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRTtZQUMzQixVQUFVLEVBQUUsQ0FBQztTQUNkLENBQUM7UUFDRixJQUFJLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNuQixLQUFLLENBQUMsS0FBSyxHQUFHLElBQUEsb0JBQVMsRUFBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDbEQsQ0FBQztRQUNELElBQUksS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDO1lBQ3ZCLEtBQUssQ0FBQyxLQUFLLEdBQUcsSUFBQSxvQkFBUyxFQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUN0RCxDQUFDO1FBQ0QsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUs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WyJpbXBvcnQgUmVhY3QgZnJvbSBcInJlYWN0XCI7XG5pbXBvcnQge1xuICBJMThuTWFuYWdlcixcbiAgSW1hZ2UsXG4gIEludGVyYWN0aW9uTWFuYWdlcixcbiAgUGFuUmVzcG9uZGVySW5zdGFuY2UsXG4gIFN0eWxlU2hlZXQsXG4gIFRvdWNoYWJsZU9wYWNpdHksXG4gIFZpZXcsXG59IGZyb20gXCJyZWFjdC1uYXRpdmVcIjtcbmltcG9ydCB0aW55Y29sb3IgZnJvbSBcInRpbnljb2xvcjJcIjtcbmltcG9ydCBTbGlkZXIgZnJvbSBcIkByZWFjdC1uYXRpdmUtY29tbXVuaXR5L3NsaWRlclwiO1xuXG5pbXBvcnQgeyBIc3ZDb2xvciwgSVBpY2tlclByb3BzLCBQb2ludDJEIH0gZnJvbSBcIi4vdHlwZUhlbHBlcnNcIjtcbmltcG9ydCB7IGNyZWF0ZVBhblJlc3BvbmRlciB9IGZyb20gXCIuL3V0aWxzXCI7XG5cbnR5cGUgU2xpZGVyUHJvcHMgPSB7XG4gIG9uVmFsdWVDaGFuZ2U/OiAodmFsdWU6IG51bWJlcikgPT4gdm9pZDtcbiAgdmFsdWU/OiBudW1iZXI7XG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIElIb2xvUGlja2VyUHJvcHMgZXh0ZW5kcyBJUGlja2VyUHJvcHMge1xuICBzbGlkZXJDb21wb25lbnQ/OiBSZWFjdC5Db21wb25lbnQ8U2xpZGVyUHJvcHM+O1xufVxuXG5leHBvcnQgdHlwZSBJSG9sb1BpY2tlclN0YXRlID0ge1xuICBjb2xvcjogSHN2Q29sb3I7XG4gIHBpY2tlclNpemU6IG51bWJlcjtcbn07XG5cbmV4cG9ydCBjbGFzcyBIb2xvQ29sb3JQaWNrZXIgZXh0ZW5kcyBSZWFjdC5QdXJlQ29tcG9uZW50PFxuICBJSG9sb1BpY2tlclByb3BzLFxuICBJSG9sb1BpY2tlclN0YXRlXG4+IHtcbiAgcHJpdmF0ZSBfbGF5b3V0OiB7IHdpZHRoOiBudW1iZXI7IGhlaWdodDogbnVtYmVyOyB4OiBudW1iZXI7IHk6IG51bWJlciB9O1xuICBwcml2YXRlIF9wYWdlWDogbnVtYmVyO1xuICBwcml2YXRlIF9wYWdlWTogbnVtYmVyO1xuICBwcml2YXRlIF9pc1JUTDogYm9vbGVhbjtcbiAgcHJpdmF0ZSBfcGlja2VyUmVzcG9uZGVyOiBQYW5SZXNwb25kZXJJbnN0YW5jZTtcbiAgcHJpdmF0ZSBwaWNrZXJDb250YWluZXI6IFJlYWN0LlJlZk9iamVjdDxWaWV3PjtcblxuICBjb25zdHJ1Y3Rvcihwcm9wczogSUhvbG9QaWNrZXJQcm9wcywgY3R4OiBhbnkpIHtcbiAgICBzdXBlcihwcm9wcywgY3R4KTtcbiAgICBjb25zdCBzdGF0ZSA9IHtcbiAgICAgIGNvbG9yOiB7IGg6IDAsIHM6IDEsIHY6IDEgfSxcbiAgICAgIHBpY2tlclNpemU6IDAsXG4gICAgfTtcbiAgICBpZiAocHJvcHMub2xkQ29sb3IpIHtcbiAgICAgIHN0YXRlLmNvbG9yID0gdGlueWNvbG9yKHByb3BzLm9sZENvbG9yKS50b0hzdigpO1xuICAgIH1cbiAgICBpZiAocHJvcHMuZGVmYXVsdENvbG9yKSB7XG4gICAgICBzdGF0ZS5jb2xvciA9IHRpbnljb2xvcihwcm9wcy5kZWZhdWx0Q29sb3IpLnRvSHN2KCk7XG4gICAgfVxuICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTtcbiAgICB0aGlzLl9sYXlvdXQgPSB7IHdpZHRoOiAwLCBoZWlnaHQ6IDAsIHg6IDAsIHk6IDAgfTtcbiAgICB0aGlzLl9wYWdlWCA9IDA7XG4gICAgdGhpcy5fcGFnZVkgPSAwO1xuICAgIHRoaXMuX29uTGF5b3V0ID0gdGhpcy5fb25MYXlvdXQuYmluZCh0aGlzKTtcbiAgICB0aGlzLl9vblNWYWx1ZUNoYW5nZSA9IHRoaXMuX29uU1ZhbHVlQ2hhbmdlLmJpbmQodGhpcyk7XG4gICAgdGhpcy5fb25WVmFsdWVDaGFuZ2UgPSB0aGlzLl9vblZWYWx1ZUNoYW5nZS5iaW5kKHRoaXMpO1xuICAgIHRoaXMuX29uQ29sb3JTZWxlY3RlZCA9IHRoaXMuX29uQ29sb3JTZWxlY3RlZC5iaW5kKHRoaXMpO1xuICAgIHRoaXMuX29uT2xkQ29sb3JTZWxlY3RlZCA9IHRoaXMuX29uT2xkQ29sb3JTZWxlY3RlZC5iaW5kKHRoaXMpO1xuICAgIHRoaXMuX2lzUlRMID0gSTE4bk1hbmFnZXIuaXNSVEw7XG4gICAgdGhpcy5fcGlja2VyUmVzcG9uZGVyID0gY3JlYXRlUGFuUmVzcG9uZGVyKHtcbiAgICAgIG9uU3RhcnQ6IHRoaXMuX2hhbmRsZUNvbG9yQ2hhbmdlLFxuICAgICAgb25Nb3ZlOiB0aGlzLl9oYW5kbGVDb2xvckNoYW5nZSxcbiAgICB9KTtcbiAgICB0aGlzLnBpY2tlckNvbnRhaW5lciA9IFJlYWN0LmNyZWF0ZVJlZigpXG4gIH1cblxuICBfZ2V0Q29sb3IoKSB7XG4gICAgY29uc3QgcGFzc2VkQ29sb3IgPVxuICAgICAgdHlwZW9mIHRoaXMucHJvcHMuY29sb3IgPT09IFwic3RyaW5nXCJcbiAgICAgICAgPyB0aW55Y29sb3IodGhpcy5wcm9wcy5jb2xvcikudG9Ic3YoKVxuICAgICAgICA6IHRoaXMucHJvcHMuY29sb3I7XG4gICAgcmV0dXJuIHBhc3NlZENvbG9yIHx8IHRoaXMuc3RhdGUuY29sb3I7XG4gIH1cblxuICBfb25Db2xvclNlbGVjdGVkKCkge1xuICAgIGNvbnN0IHsgb25Db2xvclNlbGVjdGVkIH0gPSB0aGlzLnByb3BzO1xuICAgIGNvbnN0IGNvbG9yID0gdGlueWNvbG9yKHRoaXMuX2dldENvbG9yKCkpLnRvSGV4U3RyaW5nKCk7XG4gICAgb25Db2xvclNlbGVjdGVkICYmIG9uQ29sb3JTZWxlY3RlZChjb2xvcik7XG4gIH1cblxuICBfb25PbGRDb2xvclNlbGVjdGVkKCkge1xuICAgIGNvbnN0IHsgb2xkQ29sb3IsIG9uT2xkQ29sb3JTZWxlY3RlZCB9ID0gdGhpcy5wcm9wcztcbiAgICBjb25zdCBjb2xvciA9IHRpbnljb2xvcihvbGRDb2xvcik7XG4gICAgdGhpcy5zZXRTdGF0ZSh7IGNvbG9yOiBjb2xvci50b0hzdigpIH0pO1xuICAgIG9uT2xkQ29sb3JTZWxlY3RlZCAmJiBvbk9sZENvbG9yU2VsZWN0ZWQoY29sb3IudG9IZXhTdHJpbmcoKSk7XG4gIH1cblxuICBfb25TVmFsdWVDaGFuZ2UoczogbnVtYmVyKSB7XG4gICAgY29uc3QgeyBoLCB2IH0gPSB0aGlzLl9nZXRDb2xvcigpO1xuICAgIHRoaXMuX29uQ29sb3JDaGFuZ2UoeyBoLCBzLCB2IH0pO1xuICB9XG5cbiAgX29uVlZhbHVlQ2hhbmdlKHY6IG51bWJlcikge1xuICAgIGNvbnN0IHsgaCwgcyB9ID0gdGhpcy5fZ2V0Q29sb3IoKTtcbiAgICB0aGlzLl9vbkNvbG9yQ2hhbmdlKHsgaCwgcywgdiB9KTtcbiAgfVxuXG4gIF9vbkNvbG9yQ2hhbmdlKGNvbG9yOiB7IGg6IG51bWJlcjsgczogYW55OyB2OiBhbnkgfSkge1xuICAgIHRoaXMuc2V0U3RhdGUoeyBjb2xvciB9KTtcbiAgICBpZiAodGhpcy5wcm9wcy5vbkNvbG9yQ2hhbmdlKSB7XG4gICAgICB0aGlzLnByb3BzLm9uQ29sb3JDaGFuZ2UoY29sb3IpO1xuICAgIH1cbiAgfVxuXG4gIF9vbkxheW91dChsOiB7XG4gICAgbmF0aXZlRXZlbnQ6IHtcbiAgICAgIGxheW91dDogeyB3aWR0aDogbnVtYmVyOyBoZWlnaHQ6IG51bWJlcjsgeDogbnVtYmVyOyB5OiBudW1iZXIgfTtcbiAgICB9O1xuICB9KSB7XG4gICAgdGhpcy5fbGF5b3V0ID0gbC5uYXRpdmVFdmVudC5sYXlvdXQ7XG4gICAgY29uc3QgeyB3aWR0aCwgaGVpZ2h0IH0gPSB0aGlzLl9sYXlvdXQ7XG4gICAgY29uc3QgcGlja2VyU2l6ZSA9IE1hdGgubWluKHdpZHRoLCBoZWlnaHQpO1xuICAgIGlmICh0aGlzLnN0YXRlLnBpY2tlclNpemUgIT09IHBpY2tlclNpemUpIHtcbiAgICAgIHRoaXMuc2V0U3RhdGUoeyBwaWNrZXJTaXplIH0pO1xuICAgIH1cbiAgICAvLyBsYXlvdXQueCwgbGF5b3V0LnkgaXMgYWx3YXlzIDBcbiAgICAvLyB3ZSBhbHdheXMgbWVhc3VyZSBiZWNhdXNlIGxheW91dCBpcyB0aGUgc2FtZSBldmVuIHRob3VnaCBwaWNrZXIgaXMgbW92ZWQgb24gdGhlIHBhZ2VcbiAgICBJbnRlcmFjdGlvbk1hbmFnZXIucnVuQWZ0ZXJJbnRlcmFjdGlvbnMoKCkgPT4ge1xuICAgICAgLy8gbWVhc3VyZSBvbmx5IGFmdGVyIChwb3NzaWJsZSkgYW5pbWF0aW9uIGVuZGVkXG4gICAgICB0aGlzLnBpY2tlckNvbnRhaW5lci5jdXJyZW50ICYmXG4gICAgICAgICh0aGlzLnBpY2tlckNvbnRhaW5lci5jdXJyZW50IGFzIGFueSkubWVhc3VyZShcbiAgICAgICAgICAoXG4gICAgICAgICAgICB4OiBudW1iZXIsXG4gICAgICAgICAgICB5OiBudW1iZXIsXG4gICAgICAgICAgICB3aWR0aDogbnVtYmVyLFxuICAgICAgICAgICAgaGVpZ2h0OiBudW1iZXIsXG4gICAgICAgICAgICBwYWdlWDogbnVtYmVyLFxuICAgICAgICAgICAgcGFnZVk6IG51bWJlclxuICAgICAgICAgICkgPT4ge1xuICAgICAgICAgICAgLy8gcGlja2VyIHBvc2l0aW9uIGluIHRoZSBzY3JlZW5cbiAgICAgICAgICAgIHRoaXMuX3BhZ2VYID0gcGFnZVg7XG4gICAgICAgICAgICB0aGlzLl9wYWdlWSA9IHBhZ2VZO1xuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIF9oYW5kbGVDb2xvckNoYW5nZSA9ICh7IHgsIHkgfTogUG9pbnQyRCkgPT4ge1xuICAgIGNvbnN0IHsgcywgdiB9ID0gdGhpcy5fZ2V0Q29sb3IoKTtcbiAgICBjb25zdCBtYXJnaW5MZWZ0ID0gKHRoaXMuX2xheW91dC53aWR0aCAtIHRoaXMuc3RhdGUucGlja2VyU2l6ZSkgLyAyO1xuICAgIGNvbnN0IG1hcmdpblRvcCA9ICh0aGlzLl9sYXlvdXQuaGVpZ2h0IC0gdGhpcy5zdGF0ZS5waWNrZXJTaXplKSAvIDI7XG4gICAgY29uc3QgcmVsYXRpdmVYID0geCAtIHRoaXMuX3BhZ2VYIC0gbWFyZ2luTGVmdDtcbiAgICBjb25zdCByZWxhdGl2ZVkgPSB5IC0gdGhpcy5fcGFnZVkgLSBtYXJnaW5Ub3A7XG4gICAgY29uc3QgaCA9IHRoaXMuX2NvbXB1dGVIVmFsdWUocmVsYXRpdmVYLCByZWxhdGl2ZVkpO1xuICAgIHRoaXMuX29uQ29sb3JDaGFuZ2UoeyBoLCBzLCB2IH0pO1xuXG4gICAgcmV0dXJuIHRydWU7XG4gIH07XG5cbiAgX2NvbXB1dGVIVmFsdWUoeDogbnVtYmVyLCB5OiBudW1iZXIpIHtcbiAgICBjb25zdCBteCA9IHRoaXMuc3RhdGUucGlja2VyU2l6ZSAvIDI7XG4gICAgY29uc3QgbXkgPSB0aGlzLnN0YXRlLnBpY2tlclNpemUgLyAyO1xuICAgIGNvbnN0IGR4ID0geCAtIG14O1xuICAgIGNvbnN0IGR5ID0geSAtIG15O1xuICAgIGNvbnN0IHJhZCA9IE1hdGguYXRhbjIoZHgsIGR5KSArIE1hdGguUEkgKyBNYXRoLlBJIC8gMjtcbiAgICByZXR1cm4gKChyYWQgKiAxODApIC8gTWF0aC5QSSkgJSAzNjA7XG4gIH1cblxuICBfaFZhbHVlVG9SYWQoZGVnOiBudW1iZXIpIHtcbiAgICBjb25zdCByYWQgPSAoZGVnICogTWF0aC5QSSkgLyAxODA7XG4gICAgcmV0dXJuIHJhZCAtIE1hdGguUEkgLSBNYXRoLlBJIC8gMjtcbiAgfVxuXG4gIF9nZXRTbGlkZXIoKTogdHlwZW9mIFNsaWRlciB8IGFueSB7XG4gICAgaWYgKHRoaXMucHJvcHMuaGlkZVNsaWRlcnMpIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMucHJvcHMuc2xpZGVyQ29tcG9uZW50KSB7XG4gICAgICByZXR1cm4gdGhpcy5wcm9wcy5zbGlkZXJDb21wb25lbnQgYXMgYW55O1xuICAgIH1cblxuICAgIGlmICghU2xpZGVyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIFwiWW91IG5lZWQgdG8gaW5zdGFsbCBgQHJlYWN0LW5hdGl2ZS1jb21tdW5pdHkvc2xpZGVyYCBhbmQgcGFzcyBpdCAob3IgYW55IG90aGVyIFNsaWRlciBjb21wYXRpYmxlIGNvbXBvbmVudCkgYXMgYHNsaWRlckNvbXBvbmVudGAgcHJvcFwiXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBTbGlkZXI7XG4gIH1cblxuICBnZXRDb2xvcigpIHtcbiAgICByZXR1cm4gdGlueWNvbG9yKHRoaXMuX2dldENvbG9yKCkpLnRvSGV4U3RyaW5nKCk7XG4gIH1cblxuICByZW5kZXIoKSB7XG4gICAgY29uc3QgeyBwaWNrZXJTaXplIH0gPSB0aGlzLnN0YXRlO1xuICAgIGNvbnN0IHsgb2xkQ29sb3IsIHN0eWxlIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgY29uc3QgY29sb3IgPSB0aGlzLl9nZXRDb2xvcigpO1xuICAgIGNvbnN0IHsgaCwgcywgdiB9ID0gY29sb3I7XG4gICAgY29uc3QgYW5nbGUgPSB0aGlzLl9oVmFsdWVUb1JhZChoKTtcbiAgICBjb25zdCBzZWxlY3RlZENvbG9yID0gdGlueWNvbG9yKGNvbG9yKS50b0hleFN0cmluZygpO1xuICAgIGNvbnN0IGluZGljYXRvckNvbG9yID0gdGlueWNvbG9yKHsgaCwgczogMSwgdjogMSB9KS50b0hleFN0cmluZygpO1xuXG4gICAgY29uc3QgY29tcHV0ZWQgPSBtYWtlQ29tcHV0ZWRTdHlsZXMoe1xuICAgICAgcGlja2VyU2l6ZSxcbiAgICAgIHNlbGVjdGVkQ29sb3IsXG4gICAgICBpbmRpY2F0b3JDb2xvcixcbiAgICAgIG9sZENvbG9yLFxuICAgICAgYW5nbGUsXG4gICAgICBpc1JUTDogdGhpcy5faXNSVEwsXG4gICAgfSk7XG5cbiAgICBjb25zdCBTbGlkZXJDb21wID0gdGhpcy5fZ2V0U2xpZGVyKCk7XG5cbiAgICByZXR1cm4gKFxuICAgICAgPFZpZXcgc3R5bGU9e3N0eWxlfT5cbiAgICAgICAgPFZpZXdcbiAgICAgICAgICBvbkxheW91dD17dGhpcy5fb25MYXlvdXR9XG4gICAgICAgICAgcmVmPXt0aGlzLnBpY2tlckNvbnRhaW5lcn1cbiAgICAgICAgICBzdHlsZT17c3R5bGVzLnBpY2tlckNvbnRhaW5lcn1cbiAgICAgICAgPlxuICAgICAgICAgIHshcGlja2VyU2l6ZSA/IG51bGwgOiAoXG4gICAgICAgICAgICA8Vmlldz5cbiAgICAgICAgICAgICAgPFZpZXdcbiAgICAgICAgICAgICAgICB7Li4udGhpcy5fcGlja2VyUmVzcG9uZGVyLnBhbkhhbmRsZXJzfVxuICAgICAgICAgICAgICAgIHN0eWxlPXtbY29tcHV0ZWQucGlja2VyXX1cbiAgICAgICAgICAgICAgICBjb2xsYXBzYWJsZT17ZmFsc2V9XG4gICAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgICA8SW1hZ2VcbiAgICAgICAgICAgICAgICAgIHNvdXJjZT17cmVxdWlyZShcIi4uL3Jlc291cmNlcy9jb2xvci1jaXJjbGUucG5nXCIpfVxuICAgICAgICAgICAgICAgICAgcmVzaXplTW9kZT1cImNvbnRhaW5cIlxuICAgICAgICAgICAgICAgICAgc3R5bGU9e1tzdHlsZXMucGlja2VySW1hZ2VdfVxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgICAgPFZpZXdcbiAgICAgICAgICAgICAgICAgIHN0eWxlPXtbc3R5bGVzLnBpY2tlckluZGljYXRvciwgY29tcHV0ZWQucGlja2VySW5kaWNhdG9yXX1cbiAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICA8L1ZpZXc+XG4gICAgICAgICAgICAgIHtvbGRDb2xvciAmJiAoXG4gICAgICAgICAgICAgICAgPFRvdWNoYWJsZU9wYWNpdHlcbiAgICAgICAgICAgICAgICAgIHN0eWxlPXtbc3R5bGVzLnNlbGVjdGVkUHJldmlldywgY29tcHV0ZWQuc2VsZWN0ZWRQcmV2aWV3XX1cbiAgICAgICAgICAgICAgICAgIG9uUHJlc3M9e3RoaXMuX29uQ29sb3JTZWxlY3RlZH1cbiAgICAgICAgICAgICAgICAgIGFjdGl2ZU9wYWNpdHk9ezAuN31cbiAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICApfVxuICAgICAgICAgICAgICB7b2xkQ29sb3IgJiYgKFxuICAgICAgICAgICAgICAgIDxUb3VjaGFibGVPcGFjaXR5XG4gICAgICAgICAgICAgICAgICBzdHlsZT17W3N0eWxlcy5vcmlnaW5hbFByZXZpZXcsIGNvbXB1dGVkLm9yaWdpbmFsUHJldmlld119XG4gICAgICAgICAgICAgICAgICBvblByZXNzPXt0aGlzLl9vbk9sZENvbG9yU2VsZWN0ZWR9XG4gICAgICAgICAgICAgICAgICBhY3RpdmVPcGFjaXR5PXswLjd9XG4gICAgICAgICAgICAgICAgLz5cbiAgICAgICAgICAgICAgKX1cbiAgICAgICAgICAgICAgeyFvbGRDb2xvciAmJiAoXG4gICAgICAgICAgICAgICAgPFRvdWNoYWJsZU9wYWNpdHlcbiAgICAgICAgICAgICAgICAgIHN0eWxlPXtbXG4gICAgICAgICAgICAgICAgICAgIHN0eWxlcy5zZWxlY3RlZEZ1bGxQcmV2aWV3LFxuICAgICAgICAgICAgICAgICAgICBjb21wdXRlZC5zZWxlY3RlZEZ1bGxQcmV2aWV3LFxuICAgICAgICAgICAgICAgICAgXX1cbiAgICAgICAgICAgICAgICAgIG9uUHJlc3M9e3RoaXMuX29uQ29sb3JTZWxlY3RlZH1cbiAgICAgICAgICAgICAgICAgIGFjdGl2ZU9wYWNpdHk9ezAuN31cbiAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICApfVxuICAgICAgICAgICAgPC9WaWV3PlxuICAgICAgICAgICl9XG4gICAgICAgIDwvVmlldz5cbiAgICAgICAge3RoaXMucHJvcHMuaGlkZVNsaWRlcnMgPyBudWxsIDogKFxuICAgICAgICAgIDxWaWV3PlxuICAgICAgICAgICAgPFNsaWRlckNvbXAgdmFsdWU9e3N9IG9uVmFsdWVDaGFuZ2U9e3RoaXMuX29uU1ZhbHVlQ2hhbmdlfSAvPlxuICAgICAgICAgICAgPFNsaWRlckNvbXAgdmFsdWU9e3Z9IG9uVmFsdWVDaGFuZ2U9e3RoaXMuX29uVlZhbHVlQ2hhbmdlfSAvPlxuICAgICAgICAgIDwvVmlldz5cbiAgICAgICAgKX1cbiAgICAgIDwvVmlldz5cbiAgICApO1xuICB9XG59XG5cbmNvbnN0IG1ha2VDb21wdXRlZFN0eWxlcyA9ICh7XG4gIGluZGljYXRvckNvbG9yLFxuICBzZWxlY3RlZENvbG9yLFxuICBvbGRDb2xvcixcbiAgYW5nbGUsXG4gIHBpY2tlclNpemUsXG4gIGlzUlRMLFxufTogYW55KSA9PiB7XG4gIGNvbnN0IHN1bW1hcnlTaXplID0gMC41ICogcGlja2VyU2l6ZTtcbiAgY29uc3QgaW5kaWNhdG9yUGlja2VyUmF0aW8gPSA0MiAvIDUxMDsgLy8gY29tcHV0ZWQgZnJvbSBwaWNrZXIgaW1hZ2VcbiAgY29uc3QgaW5kaWNhdG9yU2l6ZSA9IGluZGljYXRvclBpY2tlclJhdGlvICogcGlja2VyU2l6ZTtcbiAgY29uc3QgcGlja2VyUGFkZGluZyA9IGluZGljYXRvclNpemUgLyAzO1xuICBjb25zdCBpbmRpY2F0b3JSYWRpdXMgPSBwaWNrZXJTaXplIC8gMiAtIGluZGljYXRvclNpemUgLyAyIC0gcGlja2VyUGFkZGluZztcbiAgY29uc3QgbXggPSBwaWNrZXJTaXplIC8gMjtcbiAgY29uc3QgbXkgPSBwaWNrZXJTaXplIC8gMjtcbiAgY29uc3QgZHggPSBNYXRoLmNvcyhhbmdsZSkgKiBpbmRpY2F0b3JSYWRpdXM7XG4gIGNvbnN0IGR5ID0gTWF0aC5zaW4oYW5nbGUpICogaW5kaWNhdG9yUmFkaXVzO1xuICByZXR1cm4ge1xuICAgIHBpY2tlcjoge1xuICAgICAgcGFkZGluZzogcGlja2VyUGFkZGluZyxcbiAgICAgIHdpZHRoOiBwaWNrZXJTaXplLFxuICAgICAgaGVpZ2h0OiBwaWNrZXJTaXplLFxuICAgIH0sXG4gICAgcGlja2VySW5kaWNhdG9yOiB7XG4gICAgICB0b3A6IG14ICsgZHggLSBpbmRpY2F0b3JTaXplIC8gMixcbiAgICAgIFtpc1JUTCA/IFwicmlnaHRcIiA6IFwibGVmdFwiXTogbXkgKyBkeSAtIGluZGljYXRvclNpemUgLyAyLFxuICAgICAgd2lkdGg6IGluZGljYXRvclNpemUsXG4gICAgICBoZWlnaHQ6IGluZGljYXRvclNpemUsXG4gICAgICBib3JkZXJSYWRpdXM6IGluZGljYXRvclNpemUgLyAyLFxuICAgICAgYmFja2dyb3VuZENvbG9yOiBpbmRpY2F0b3JDb2xvcixcbiAgICB9LFxuICAgIHNlbGVjdGVkUHJldmlldzoge1xuICAgICAgd2lkdGg6IHN1bW1hcnlTaXplIC8gMixcbiAgICAgIGhlaWdodDogc3VtbWFyeVNpemUsXG4gICAgICB0b3A6IHBpY2tlclNpemUgLyAyIC0gc3VtbWFyeVNpemUgLyAyLFxuICAgICAgbGVmdDogTWF0aC5mbG9vcihwaWNrZXJTaXplIC8gMiksXG4gICAgICBib3JkZXJUb3BSaWdodFJhZGl1czogc3VtbWFyeVNpemUgLyAyLFxuICAgICAgYm9yZGVyQm90dG9tUmlnaHRSYWRpdXM6IHN1bW1hcnlTaXplIC8gMixcbiAgICAgIGJhY2tncm91bmRDb2xvcjogc2VsZWN0ZWRDb2xvcixcbiAgICB9LFxuICAgIG9yaWdpbmFsUHJldmlldzoge1xuICAgICAgd2lkdGg6IE1hdGguY2VpbChzdW1tYXJ5U2l6ZSAvIDIpLFxuICAgICAgaGVpZ2h0OiBzdW1tYXJ5U2l6ZSxcbiAgICAgIHRvcDogcGlja2VyU2l6ZSAvIDIgLSBzdW1tYXJ5U2l6ZSAvIDIsXG4gICAgICBsZWZ0OiBwaWNrZXJTaXplIC8gMiAtIHN1bW1hcnlTaXplIC8gMixcbiAgICAgIGJvcmRlclRvcExlZnRSYWRpdXM6IHN1bW1hcnlTaXplIC8gMixcbiAgICAgIGJvcmRlckJvdHRvbUxlZnRSYWRpdXM6IHN1bW1hcnlTaXplIC8gMixcbiAgICAgIGJhY2tncm91bmRDb2xvcjogb2xkQ29sb3IsXG4gICAgfSxcbiAgICBzZWxlY3RlZEZ1bGxQcmV2aWV3OiB7XG4gICAgICB3aWR0aDogc3VtbWFyeVNpemUsXG4gICAgICBoZWlnaHQ6IHN1bW1hcnlTaXplLFxuICAgICAgdG9wOiBwaWNrZXJTaXplIC8gMiAtIHN1bW1hcnlTaXplIC8gMixcbiAgICAgIGxlZnQ6IHBpY2tlclNpemUgLyAyIC0gc3VtbWFyeVNpemUgLyAyLFxuICAgICAgYm9yZGVyUmFkaXVzOiBzdW1tYXJ5U2l6ZSAvIDIsXG4gICAgICBiYWNrZ3JvdW5kQ29sb3I6IHNlbGVjdGVkQ29sb3IsXG4gICAgfSxcbiAgfTtcbn07XG5cbmNvbnN0IHN0eWxlcyA9IFN0eWxlU2hlZXQuY3JlYXRlKHtcbiAgcGlja2VyQ29udGFpbmVyOiB7XG4gICAgZmxleDogMSxcbiAgICBhbGlnbkl0ZW1zOiBcImNlbnRlclwiLFxuICAgIGp1c3RpZnlDb250ZW50OiBcImNlbnRlclwiLFxuICB9LFxuICBwaWNrZXJJbWFnZToge1xuICAgIGZsZXg6IDEsXG4gICAgd2lkdGg6IG51bGwsXG4gICAgaGVpZ2h0OiBudWxsLFxuICB9LFxuICBwaWNrZXJJbmRpY2F0b3I6IHtcbiAgICBwb3NpdGlvbjogXCJhYnNvbHV0ZVwiLFxuICAgIC8vIFNoYWRvdyBvbmx5IHdvcmtzIG9uIGlPUy5cbiAgICBzaGFkb3dDb2xvcjogXCJibGFja1wiLFxuICAgIHNoYWRvd09wYWNpdHk6IDAuMyxcbiAgICBzaGFkb3dPZmZzZXQ6IHsgd2lkdGg6IDMsIGhlaWdodDogMyB9LFxuICAgIHNoYWRvd1JhZGl1czogNCxcblxuICAgIC8vIFRoaXMgd2lsbCBlbGV2YXRlIHRoZSB2aWV3IG9uIEFuZHJvaWQsIGNhdXNpbmcgc2hhZG93IHRvIGJlIGRyYXduLlxuICAgIGVsZXZhdGlvbjogNSxcbiAgfSxcbiAgc2VsZWN0ZWRQcmV2aWV3OiB7XG4gICAgcG9zaXRpb246IFwiYWJzb2x1dGVcIixcbiAgICBib3JkZXJMZWZ0V2lkdGg6IDAsXG4gIH0sXG4gIG9yaWdpbmFsUHJldmlldzoge1xuICAgIHBvc2l0aW9uOiBcImFic29sdXRlXCIsXG4gICAgYm9yZGVyUmlnaHRXaWR0aDogMCxcbiAgfSxcbiAgc2VsZWN0ZWRGdWxsUHJldmlldzoge1xuICAgIHBvc2l0aW9uOiBcImFic29sdXRlXCIsXG4gIH0sXG4gIHBpY2tlckFsaWdubWVudDoge1xuICAgIGFsaWduSXRlbXM6IFwiY2VudGVyXCIsXG4gIH0sXG59KTtcbiJdfQ==